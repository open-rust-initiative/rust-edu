# ğŸ‰db

ğŸ‰ is completed by rjc, ghb and zyc together. You can access this repo, click [here](https://github.com/Watermelon-Family/waterdb).

ğŸ‰ is a simple relation database, inspired by miniob-2023, mini-redis, leveldb, simple-db and toydb.

```rust
// run server
cargo run --bin waterdb-server

// run client
cargo run --bin waterdb-cli
```

## ğŸ‰DB SQL Engine

ğŸ‰db ä¸ºæ¯ä¸€ä¸ª sokect éƒ½ä¼šåˆ›å»ºä¸€ä¸ª ğŸ‰ sessionã€‚session æ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼ˆå¿«ç…§éš”ç¦»ï¼‰ã€‚åç»­ client çš„æ“ä½œéƒ½æ˜¯ç›´æ¥å’Œ session äº¤äº’çš„ã€‚

ç”¨æˆ·è¾“å…¥çš„ query ä¼šè¿›è¿‡ä¸‹åˆ—é˜¶æ®µï¼Œæœ€åå¾—åˆ°æ‰§è¡Œç»“æœï¼š

1. Parserï¼šå°†ç”¨æˆ·è¾“å…¥çš„ query string è½¬åŒ–ä¸º Statement
2. Plannerï¼šå°† Statement è½¬åŒ–ä¸ºæ‰§è¡Œè®¡åˆ’ï¼ˆé€»è¾‘æ‰§è¡Œè®¡åˆ’ï¼‰
3. Optimizer: å°†æ‰§è¡Œè®¡åˆ’è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚è°“è¯ä¸‹æ¨ç­‰ç­‰ã€‚å¾—åˆ°ä¼˜åŒ–ä¹‹åçš„æ‰§è¡Œè®¡åˆ’ã€‚
4. Executorï¼šæ ¹æ®é€»è¾‘è®¡åˆ’ç”Ÿæˆç‰©ç†æ‰§è¡Œè®¡åˆ’(ç®—å­)ã€‚æ¯ä¸€ä¸ªç®—å­éƒ½ä¼šæœ‰å¯¹åº”çš„ executor æ–¹æ³•ã€‚

åœ¨ SQL Engine ä¸­ï¼Œæ¯ä¸€æ¡ SQL çš„æ‰§è¡Œéƒ½æ˜¯é€šè¿‡äº‹åŠ¡çš„ã€‚Txn é€šè¿‡ Engine ç”Ÿæˆã€‚

ğŸ‰DB çš„å…ƒæ•°æ®é€šè¿‡ Catalog trait è¿›è¡Œç®¡ç†ï¼Œå³å®ç° Catalog å³å¯æ‰§è¡Œ DDLã€‚Catalog trait ä¼šè¢« Txn å®ç°ã€‚ä»è€Œä½¿å¾— Txn å¯ä»¥æ‰§è¡Œ DDLã€‚

ğŸ‰DB çš„æ•°æ®ç®¡ç†åˆ™æ˜¯ Transaction trait ç®¡ç†çš„ï¼Œé€šè¿‡å®ç° Transaction trait ä½¿å¾— Txn å¯ä»¥æ‰§è¡Œ DMLã€‚



å‚è€ƒ miniobå¹¶ä¸”å¾—ç›Šäº rust ä¸­æšä¸¾ç±»å‹çš„å¼ºå¤§ï¼ŒğŸ‰db ä¸­ Value é€šè¿‡æšä¸¾å®ç°ã€‚

```rust
#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
pub enum Value {
    Null,
    Boolean(bool),
    Integer(i64),
    Float(f64),
    String(String),
}
```

å¯¹äºè¡Œæ•°æ®æ˜¯é€šè¿‡ `Vec<Value>` å®ç°çš„ã€‚

## ğŸ‰DB Storage Engine

å­˜å‚¨å¼•æ“æ˜¯é€šè¿‡ Bitcask å®ç°çš„ã€‚Bitcask æ˜¯åŸºäºæ—¥å¿—çš„ã€‚ç±»ä¼¼äº LSM Treeï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯é€šè¿‡ Append Entry çš„æ–¹å¼å®ç°çš„ã€‚

![Bitcask](https://pic3.zhimg.com/80/v2-0179c2d04ed19b9e3fad9f842bd16b52_1440w.webp)

ä¸€æ¡ Entry çš„ç»“æ„å¦‚å›¾ã€‚Bitcask é€šè¿‡åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ª Mapï¼Œkey ä¸ºå­˜å‚¨çš„ keyã€‚value æ˜¯ Entry çš„ metadataã€‚



### MVCC

>  MVCC å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼šæŒ‡åœ¨æ•°æ®åº“ä¸­ç»´æŠ¤ä¸€æ¡è®°å½•çš„å¤šä¸ªå‰¯æœ¬ã€‚è¾¾åˆ°å†™ä¸å½±å“è¯»ï¼Œè¯»ä¸å½±å“å†™çš„æ•ˆæœã€‚ç”±äºæŒ‡è§£å†³äº† R-W çš„å†²çªï¼Œå¹¶æ²¡æœ‰è§£å†³ W-W çš„å†²çªï¼Œæ‰€ä»¥ MVCC æ§åˆ¶åè®®å¹¶ä¸å®Œæ•´ã€‚WaterDB é‡‡ç”¨äº†ä¹è§‚é”çš„æœºåˆ¶ï¼Œåœ¨å‡ºç° W-W å†²çªçš„æ—¶å€™ä¼šè¿›è¡Œ retryã€‚MV2PL å’Œ MVOCC å¯ä»¥è§£å†³ W-W å†²çªçš„é—®é¢˜ã€‚
>
> time-travelï¼šå¦‚æœä¿å­˜ä¹‹å‰å…¨éƒ¨çš„å‰¯æœ¬ä¿¡æ¯ï¼ŒDBMSå°±å¯ä»¥æ”¯æŒè¯»å–ä»»æ„ç‰ˆæœ¬çš„ä¿¡æ¯

ğŸ‰db æ”¯æŒ MVCCï¼Œæä¾›çš„éš”ç¦»çº§åˆ«æ˜¯å¿«ç…§éš”ç¦»ã€‚åœ¨äº‹åŠ¡çœ¼ä¸­çš„æ•°æ®åº“æ˜¯åˆ›å»ºäº‹åŠ¡çš„ä¸€ä¸ª snapshotã€‚äº‹åŠ¡åªèƒ½çœ‹åˆ° snapshot çš„æ•°æ®ï¼Œä»¥åŠè‡ªå·±å†™å…¥çš„æ•°æ®ã€‚ä¿è¯äº†éš”ç¦»æ€§ã€å¯é‡å¤è¯»ä»¥åŠé¿å…äº†å¹»è¯»ã€‚ä½†æ˜¯ä¼šäº§ç”Ÿ W-W å†²çªã€‚

ç”±äºæ²¡æœ‰å®ç° GCï¼Œæ‰€ä»¥ ğŸ‰db æ”¯æŒ time-travel queryï¼Œå³ç»™å®š txnï¼Œå¯ä»¥åˆ›å»ºå‡ºå¯¹åº”çŠ¶æ€çš„ snapshotã€‚

- åŸå­æ€§ï¼šåœ¨äº‹åŠ¡ commit çš„æ—¶å€™ï¼Œä¼šå°†ä»–ä» active ä¸­åˆ é™¤ã€‚è¿™æ ·ä¹‹ååˆ›å»ºçš„äº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°å½“å‰äº‹åŠ¡çš„ä¿®æ”¹ï¼Œä»è€Œå®ç°åŸå­æ€§ã€‚

- å¯é‡å¤è¯»ï¼šå½“åˆ›å»ºäº‹åŠ¡çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºå‡ºå¯¹åº” txn active-setã€‚æ‰€ä»¥è¿™äº› active-set äº‹åŠ¡çš„ä¿®æ”¹å¯¹è¯¥ txn æ˜¯ä¸å¯è§çš„ã€‚

ç”±äº rust å¯ä»¥å¯¹å¤æ‚ç±»å‹çš„ Enum ç±»å‹è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ© bitcask è½»æ¾å®ç° MVCCã€‚

